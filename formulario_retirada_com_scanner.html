<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Retirada de Produtos</title>
  <script src="https://cdn.jsdelivr.net/npm/jspdf"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    input, textarea, select, canvas, button { display: block; margin-bottom: 15px; width: 100%; max-width: 400px; }
    #fotoPreview { max-width: 200px; margin-top: 10px; }
    #reader { width: 100%; max-width: 400px; margin: 20px 0; }
  </style>
  <script>
    let produtos = [];

    document.addEventListener("DOMContentLoaded", function () {
      emailjs.init("WK7cEbzDnWYMWKdxe");
    });

    function startScanner() {
      const scanner = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          const cameraId = devices[0].id;
          scanner.start(cameraId, { fps: 10, qrbox: 250 }, code => {
            document.getElementById("codigo").value = code;
            scanner.stop().then(() => {
              document.getElementById("reader").innerHTML = "";
            });
          });
        }
      }).catch(err => alert("Erro ao acessar câmera: " + err));
    }

    function adicionarProduto() {
      const produto = {
        codigo: document.getElementById("codigo").value,
        descricao: document.getElementById("descricao").value,
        quantidade: document.getElementById("quantidade").value,
        destino: document.getElementById("destino").value,
        tecnico: document.getElementById("tecnico").value,
        empresa: document.getElementById("empresa").value,
        observacoes: document.getElementById("observacoes").value,
        foto: document.getElementById("fotoPreview").src || ""
      };
      produtos.push(produto);
      alert("Produto adicionado!");
      document.getElementById("formulario-produto").reset();
      document.getElementById("fotoPreview").src = "";
    }

    function carregarFoto(event) {
      const reader = new FileReader();
      reader.onload = function () {
        document.getElementById("fotoPreview").src = reader.result;
      };
      reader.readAsDataURL(event.target.files[0]);
    }

    function tirarFoto() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.capture = "environment";
      input.onchange = carregarFoto;
      input.click();
    }

    function limparAssinatura() {
      const canvas = document.getElementById("assinatura");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function desenharAssinatura() {
      const canvas = document.getElementById("assinatura");
      const ctx = canvas.getContext("2d");
      let desenhando = false;

      canvas.onmousedown = () => desenhando = true;
      canvas.onmouseup = () => desenhando = false;
      canvas.onmousemove = (e) => {
        if (!desenhando) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      };
    }

    function gerarRelatorio(previsualizar = false) {
      const doc = new jsPDF();
      const dataAtual = new Date().toLocaleString("pt-BR");
      const destino = produtos[0]?.destino || "Sem destino";
      const controle = `${destino}-${Date.now()}`;

      doc.text(`Relatório de Retirada`, 10, 10);
      doc.text(`Controle: ${controle}`, 10, 20);
      doc.text(`Data: ${dataAtual}`, 10, 30);

      produtos.forEach((p, i) => {
        const baseY = 40 + i * 60;
        doc.text(`Produto ${i + 1}:`, 10, baseY);
        doc.text(`Código: ${p.codigo}`, 20, baseY + 10);
        doc.text(`Descrição: ${p.descricao}`, 20, baseY + 20);
        doc.text(`Qtd: ${p.quantidade}`, 20, baseY + 30);
        doc.text(`Destino: ${p.destino}`, 20, baseY + 40);
        doc.text(`Técnico: ${p.tecnico} / Empresa: ${p.empresa}`, 20, baseY + 50);
        if (p.observacoes) doc.text(`Obs: ${p.observacoes}`, 20, baseY + 60);
        if (p.foto) doc.addImage(p.foto, 'PNG', 140, baseY, 40, 30);
      });

      const assinaturaCanvas = document.getElementById("assinatura");
      const assinaturaData = assinaturaCanvas.toDataURL("image/png");
      doc.text("Assinatura:", 10, 250);
      doc.addImage(assinaturaData, 'PNG', 10, 255, 100, 30);

      if (previsualizar) {
        window.open(doc.output("bloburl"));
        return;
      }

      const pdfBase64 = doc.output("datauristring");
      emailjs.send("service_b5y97oc", "Entrega de Material", {
        to_name: produtos[0]?.tecnico || "",
        message: "Segue o relatório de retirada de material.",
        controle: controle,
        data: dataAtual,
        pdf_base64: pdfBase64
      }).then(() => {
        alert("Relatório enviado por e-mail com sucesso!");
      }).catch(err => {
        alert("Erro ao enviar e-mail: " + JSON.stringify(err));
      });
    }
  </script>
</head>
<body onload="desenharAssinatura()">
  <h2>Formulário de Retirada de Produto</h2>

  <form id="formulario-produto">
    <label>1 - Código do Produto</label>
    <input type="text" id="codigo" placeholder="Digite ou escaneie o código" required />
    <button type="button" onclick="startScanner()">Escanear Código de Barras</button>
    <div id="reader"></div>

    <label>2 - Descrição</label>
    <input type="text" id="descricao" required />

    <label>3 - Quantidade</label>
    <input type="number" id="quantidade" required />

    <label>4 - Local de Destino</label>
    <input type="text" id="destino" required />

    <label>5 - Nome do Técnico</label>
    <input type="text" id="tecnico" required />

    <label>6 - Empresa Terceira</label>
    <input type="text" id="empresa" required />

    <label>7 - Foto do Produto</label>
    <button type="button" onclick="tirarFoto()">Tirar Foto</button>
    <input type="file" accept="image/*" id="foto" onchange="carregarFoto(event)" />
    <img id="fotoPreview" src="" alt="Prévia da foto" />

    <label>8 - Observações</label>
    <textarea id="observacoes"></textarea>

    <label>9 - Adicionar Produto</label>
    <button type="button" onclick="adicionarProduto()">Adicionar Produto</button>
  </form>

  <label>10 - Assinatura</label>
  <canvas id="assinatura" width="300" height="100" style="border: 1px solid #000;"></canvas>
  <button onclick="limparAssinatura()">Limpar Assinatura</button>

  <label>11 - Gerar Relatório</label>
  <button onclick="gerarRelatorio()">Enviar por E-mail</button>
  <button onclick="gerarRelatorio(true)">Visualizar PDF</button>
</body>
</html>
